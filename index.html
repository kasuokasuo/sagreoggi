<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>A che sagra vado oggi?</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    width: 100%;
    font-family: "Arial Narrow", Arial, sans-serif;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: #ffffff;
    color: #000000;
    text-align: center;
    cursor: pointer;
    overflow-x: hidden; /* niente scroll orizzontale */
  }
  #sagra {
    user-select: none;
    line-height: 8vw;
    letter-spacing: -0.1vw;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .nome, .date, .citta {
    font-size: 10vw;
    margin: 0.1vw 0;
  }
  .buttons {
    position: fixed;
    bottom: 1em;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 2em;
  }
  .btn {
    font-size: 2em;
    cursor: pointer;
    text-decoration: none;
    transition: color 0s;
  }

  /* Vista tutte le sagre */
  #tutteContainer {
    display: none;
    flex-direction: column;
    width: 60%;
    max-width: 100vw;
    overflow-y: auto;
    overflow-x: hidden;
    text-align: left;
  }
  #tutteContainer div {
    font-size: 5vw;
    line-height: 5vw;
    margin-bottom: 1em;
    margin-top: 1em;
    text-align: center;
    white-space: pre-line;
    word-wrap: break-word;
  }

  /* Mobile */
  @media (max-width: 768px) {
    #tutteContainer {
      width: 90%;
    }
  }
</style>
</head>
<body id="body">
  <div id="sagra">
    <div class="nome"></div>
    <div class="date"></div>
    <div class="citta"></div>
  </div>
  
  <div id="tutteContainer"></div>

  <div class="buttons">
    <a 
      id="plusSagra" 
      class="btn"
      href="https://docs.google.com/forms/d/e/1FAIpQLSdQ6rZ9HWKiewle1XYEmm_ssMkNfHOvL4T6tT9rSRc7eCXsWg/viewform?usp=dialog" 
      target="_blank" 
      rel="noopener noreferrer"
    >+sagre</a>
    <div id="tutteBtn" class="btn">tutte</div>
  </div>

<script>
const JSON_URL = "sagre_processed.json";

const nomeEl = document.querySelector(".nome");
const dateEl = document.querySelector(".date");
const cittaEl = document.querySelector(".citta");
const plusBtn = document.getElementById("plusSagra");
const tutteBtn = document.getElementById("tutteBtn");
const tutteContainer = document.getElementById("tutteContainer");
const sagraBox = document.getElementById("sagra");

let sagre = [];

// combinazioni colori: [testo, sfondo]
const colors = [
  ["#000000", "#FFFF00"], 
  ["#FF0000", "#FFFFFF"], 
  ["#000000", "#FFFFFF"], 
  ["#000000", "#87CEEB"], 
  ["#FFFFFF", "#008000"]
];

let ultimaSagra = null;
let ultimoColore = -1;
let inLista = false;

function parseDate(str) {
  const months = {
    "Gennaio":0,"Febbraio":1,"Marzo":2,"Aprile":3,"Maggio":4,"Giugno":5,
    "Luglio":6,"Agosto":7,"Settembre":8,"Ottobre":9,"Novembre":10,"Dicembre":11
  };
  const m = str.trim().match(/^(\d{1,2})(?:-(\d{1,2}))?\s+([A-Za-zÀ-ÿ]+)\s+(\d{4})$/);
  if (!m) return null;

  const giornoStart = parseInt(m[1], 10);
  const giornoEnd = m[2] ? parseInt(m[2], 10) : giornoStart;
  const mese = months[m[3]];
  const anno = parseInt(m[4], 10);

  return {
    start: new Date(anno, mese, giornoStart),
    end: new Date(anno, mese, giornoEnd)
  };
}

function getAttive() {
  const oggi = new Date();
  return sagre.filter(s => {
    const range = parseDate(s.date);
    if(!range) return false;
    return oggi >= range.start && oggi <= range.end;
  });
}

function mostraSagra() {
  if (inLista) return;

  const attive = getAttive();
  if (attive.length === 0) {
    nomeEl.textContent = "Oggi niente sagra :'(";
    dateEl.textContent = "";
    cittaEl.textContent = "";
    plusBtn.style.color = "#000000"; 
    tutteBtn.style.color = "#000000"; 
    return;
  }

  const s = attive[Math.floor(Math.random() * attive.length)];

  // Cambia colore solo se cambia la sagra
  if(!ultimaSagra || s.nome !== ultimaSagra.nome) {
    let index;
    do {
      index = Math.floor(Math.random() * colors.length);
    } while(index === ultimoColore);

    ultimoColore = index;
    const c = colors[index];
    document.body.style.color = c[0];
    document.body.style.background = c[1];
    plusBtn.style.color = c[0]; 
    tutteBtn.style.color = c[0]; 
  }

  nomeEl.textContent = s.nome;
  dateEl.textContent = s.date;
  cittaEl.textContent = `${s.citta} (${s.provincia})`;

  ultimaSagra = s;
}

function mostraLista() {
  inLista = true;
  sagraBox.style.display = "none";
  tutteContainer.style.display = "flex";
  tutteContainer.innerHTML = "";

  const attive = getAttive();
  if (attive.length === 0) {
    const noDiv = document.createElement("div");
    noDiv.textContent = "Oggi niente sagra :'(";
    noDiv.style.fontSize = "5vw";
    noDiv.style.textAlign = "center";
    tutteContainer.appendChild(noDiv);
    return;
  }

  attive.forEach(s => {
    const el = document.createElement("div");
    el.style.fontSize = "5vw";
    el.style.lineHeight = "5vw";
    el.style.marginBottom = "1em";
    el.style.textAlign = "center";

    // Nome, Data e Città/Provincia a capo
    el.textContent = `${s.nome}\n${s.date}\n${s.citta} (${s.provincia})`;
    tutteContainer.appendChild(el);
  });
}

function tornaSingola() {
  if (!inLista) {
    mostraSagra();
    return;
  }
  inLista = false;
  tutteContainer.style.display = "none";
  sagraBox.style.display = "flex";
  mostraSagra();
}

// carica JSON
fetch(JSON_URL)
  .then(res => res.json())
  .then(data => {
    sagre = data;
    mostraSagra();
  })
  .catch(err => {
    console.error(err);
    nomeEl.textContent = "Errore nel caricamento sagre";
  });

// eventi
document.body.addEventListener("click", e => {
  if (e.target === plusBtn || e.target === tutteBtn) return;
  tornaSingola();
});
tutteBtn.addEventListener("click", e => {
  e.stopPropagation();
  mostraLista();
});
</script>
</body>
</html>
